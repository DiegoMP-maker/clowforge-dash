[35m[plugins][39m [36mmemory-lancedb: plugin registered (db: /home/paco/.openclaw/memory/lancedb, lazy init)[39m
<!-- FILE: conventions.md -->
```markdown
# Frontend Conventions: clowforge-dashboard

> Generated by Lead Frontend Engineer agent. The Developer MUST follow these conventions.
> The Reviewer will verify compliance. Deviations require explicit justification in PR description.

---

## 1. TypeScript Configuration

### tsconfig.json overrides
```json
{
  "compilerOptions": {
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "noImplicitOverride": true,
    "noImplicitReturns": true,
    "useUnknownInCatchVariables": true,
    "verbatimModuleSyntax": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

### Type Inference Rules
- **Prefer inference** for locals; **annotate exports and props**.
  **Correct:**
  ```ts
  const DEFAULT_POLL_MS = 10_000;
  export function formatCost(usd: number): string {
    return `$${usd.toFixed(2)}`;
  }
  ```
  **Wrong:**
  ```ts
  const DEFAULT_POLL_MS: number = 10000;
  const formatCost = (usd) => `$${usd.toFixed(2)}`;
  ```

- **Use `as const`** for literal configs.
  **Correct:**
  ```ts
  export const RUN_STATUSES = ['queued', 'running', 'failed', 'done'] as const;
  export type RunStatus = (typeof RUN_STATUSES)[number];
  ```
  **Wrong:**
  ```ts
  export const RUN_STATUSES = ['queued', 'running', 'failed', 'done'];
  export type RunStatus = string;
  ```

- **Ban list:** `any`, `@ts-ignore`, non-null assertions (`!`) outside tests.
  **Correct:**
  ```ts
  // @ts-expect-error: Supabase typing mismatch for JSON
  const payload = data as unknown as Record<string, unknown>;

  const value: unknown = getValue();
  if (typeof value === 'string') value.toUpperCase();
  ```
  **Wrong:**
  ```ts
  // @ts-ignore
  const payload = data;

  const value: any = getValue();
  value.toUpperCase();

  const el = document.querySelector('#id')!;
  ```

- **Enum policy:** string literal unions only (no `enum`).
  **Correct:**
  ```ts
  export type UserRole = 'admin' | 'viewer';
  ```
  **Wrong:**
  ```ts
  export enum UserRole {
    Admin = 'admin',
    Viewer = 'viewer'
  }
  ```

### Utility Types
Define in `src/types/utils.ts`.

```ts
export type Prettify<T> = { [K in keyof T]: T[K] } & {};
export type StrictOmit<T, K extends keyof T> = Omit<T, K>;
```

**Correct:**
```ts
import type { Prettify } from '@/types/utils';
type ProjectView = Prettify<Project & { runs: number }>;
```
**Wrong:**
```ts
type Prettify<T> = any;
```

---

## 2. ESLint & Prettier Configuration

### ESLint Rules
- Enable `@typescript-eslint/strict-type-checked`.
- `@typescript-eslint/naming-convention`:
  - `camelCase` variables/functions
  - `PascalCase` types/classes/components
  - `UPPER_CASE` constants  
  **Correct:**
  ```ts
  const MAX_PAGES = 5;
  type ProjectSummary = {};
  ```
  **Wrong:**
  ```ts
  const max_pages = 5;
  type project_summary = {};
  ```

- `import/order`:
  - groups: `builtin`, `external`, `internal`, `parent`, `sibling`, `index`, `object`, `type`
  - alphabetize: `asc`  
  **Correct:**
  ```ts
  import type { ReactNode } from 'react';
  import { z } from 'zod';

  import { cn } from '@/lib/cn';
  import { Badge } from '@/components/ui/Badge';
  ```
  **Wrong:**
  ```ts
  import { Badge } from '@/components/ui/Badge';
  import { z } from 'zod';
  ```

- `react/jsx-no-leaked-render` enabled.  
  **Correct:**
  ```tsx
  {Boolean(count) && <Badge />}
  ```
  **Wrong:**
  ```tsx
  {count && <Badge />}
  ```

- `no-console`: error in prod, warn in dev.  
  **Correct:**
  ```ts
  if (process.env.NODE_ENV === 'development') console.warn('debug');
  ```
  **Wrong:**
  ```ts
  console.log('debug');
  ```

- Additional required:
  - `@typescript-eslint/no-misused-promises`
  - `@typescript-eslint/consistent-type-imports`
  - `unused-imports/no-unused-imports`

**Correct:**
```ts
import type { Run } from '@/types/Run.types';
```
**Wrong:**
```ts
import { Run } from '@/types/Run.types';
```

### Prettier Configuration
```json
{
  "semi": true,
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 100,
  "tabWidth": 2,
  "arrowParens": "always",
  "plugins": ["prettier-plugin-tailwindcss"]
}
```

### Pre-commit Hooks
- **lint-staged**:
```json
{
  "*.{ts,tsx}": ["eslint --fix", "prettier --write"],
  "*.{md,css}": ["prettier --write"]
}
```
- **Husky**
  - `pre-commit`: lint-staged
  - `pre-push`: `pnpm typecheck && pnpm test`

**Correct:**
```sh
npx lint-staged
```
**Wrong:**
```sh
# no hooks
```

---

## 3. Project Structure & File Naming

### Directory Layout
```
src/
  app/
    login/
    projects/
    runs/
    costs/
    health/
    settings/
    api/
  components/
    ui/
    forms/
    layouts/
    projects/
    runs/
  hooks/
  lib/
    supabase/
  stores/
  types/
  styles/
```

### File Naming Rules
| Type | Convention | Example |
|------|-----------|---------|
| Components | PascalCase | `RunStatusBadge.tsx` |
| Hooks | camelCase with `use` | `useRunList.ts` |
| Utilities | camelCase | `formatDuration.ts` |
| Types | PascalCase with `.types.ts` | `Run.types.ts` |
| Constants | UPPER_SNAKE_CASE exports in camelCase file | `constants.ts` |
| API routes | kebab-case directory | `api/run-stats/route.ts` |
| Test files | `.test.ts(x)` | `RunRow.test.tsx` |

**Correct:**
```ts
// src/components/runs/RunRow.tsx
```
**Wrong:**
```ts
// src/components/runs/run-row.tsx
```

### Co-location Rules
- Component + test in same directory.
- If directory has >1 component, add **local** `index.ts` barrel.
- **Never** create a global `components/index.ts`.

**Correct:**
```ts
// src/components/runs/index.ts
export { RunRow } from './RunRow';
export { RunStatusBadge } from './RunStatusBadge';
```
**Wrong:**
```ts
// src/components/index.ts
export * from './runs';
```

### Module Boundaries
- `components/` may import from `lib/`, `types/`, `hooks/`, `stores/`.
- `components/` must NOT import from `app/` or `api/`.

**Correct:**
```ts
import { cn } from '@/lib/cn';
```
**Wrong:**
```ts
import { GET } from '@/app/api/runs/route';
```

---

## 4. Component Patterns

### Component Declaration
```tsx
// CORRECT
export function RunRow({ run }: RunRowProps): React.ReactElement {
  return <div>{run.id}</div>;
}

// WRONG
export default ({ run }) => <div>{run.id}</div>;
```

### Props
- Use **type alias** for props.
- Name props `{ComponentName}Props`.
- Children: `children?: React.ReactNode`.
- Destructure in signature.

**Correct:**
```tsx
type CardProps = { title: string; children?: React.ReactNode };

export function Card({ title, children }: CardProps): React.ReactElement {
  return <section>{children}</section>;
}
```
**Wrong:**
```tsx
interface CardProps { title: string }
export const Card = (props) => <section>{props.children}</section>;
```

### Event Handlers
- Props: `on{Event}`
- Internal: `handle{Event}`

**Correct:**
```tsx
type FiltersProps = { onChange: () => void };

export function Filters({ onChange }: FiltersProps) {
  function handleChange(): void {
    onChange();
  }
  return <button onClick={handleChange} />;
}
```
**Wrong:**
```tsx
export function Filters({ onChange }) {
  return <button onClick={() => onChange()} />;
}
```

### Component Composition
- Use hooks for shared logic.
- Split component if >150 lines, >3 responsibilities, or >5 props.

**Correct:**
```tsx
function useRunFilters() {}
```
**Wrong:**
```tsx
function RunsPage() { /* filters + fetching + layout + rendering */ }
```

### Component Categories
| Category | Directory | Description | Can depend on |
|----------|-----------|-------------|---------------|
| UI primitives | `components/ui/` | Buttons, inputs, badges | Only `lib/`, `types/` |
| Form components | `components/forms/` | Form fields, validation | UI primitives, `lib/`, `hooks/` |
| Layout components | `components/layouts/` | Shells, nav | UI primitives |
| Feature components | `components/{feature}/` | Business UI | All above |

---

## 5. State Management

### Local State
- `useState` for UI-only state.
- `useReducer` if >3 related state variables.

**Correct:**
```tsx
const [isOpen, setIsOpen] = useState(false);
```
**Wrong:**
```tsx
const [state, setState] = useState({ a: '', b: '', c: '' });
```

### Server State (React Query)
- Query key format: `['{entity}', '{action}', params]`.

**Correct:**
```ts
useQuery({ queryKey: ['runs', 'list', { status }], queryFn: fetchRuns });
```
**Wrong:**
```ts
useQuery({ queryKey: ['runs'], queryFn: fetchRuns });
```

- One hook per entity/action.

**Correct:**
```ts
export function useRunList(filters: RunFilters) {}
```
**Wrong:**
```ts
export function useData() {}
```

- Stale time defaults:
  - static: 5 min
  - dynamic: 30 s
  - real-time: 0

### Global Client State (Zustand)
- Use only for UI preference toggles (e.g., table density).
- Store naming: `use{Domain}Store`.

**Correct:**
```ts
const useTablePrefsStore = create(() => ({ density: 'compact' as const }));
```
**Wrong:**
```ts
const useRunsStore = create(() => ({ runs: [] })); // server data
```

### URL State
Filters and pagination in search params.

**Correct:**
```tsx
const params = useSearchParams();
const page = params.get('page') ?? '1';
```
**Wrong:**
```tsx
const [page] = useState('1');
```

---

## 6. Data Fetching Patterns

### Supabase Client Usage
```tsx
// Server Component
import { createServerClient } from '@/lib/supabase/server';
const supabase = await createServerClient();
const { data, error } = await supabase.from('forge_runs').select('*');

// Client Component
import { createBrowserClient } from '@/lib/supabase/client';
const supabase = createBrowserClient();
```

### Data Fetching Rules
1. Server Components fetch directly with server client.
2. Client Components fetch via React Query hooks.
3. Never call `fetch()` in component bodies.
4. Never store Supabase responses in `useState`.
5. Always type queries with `.returns<Type[]>()`.
6. Always handle `error`.

**Correct:**
```ts
const { data, error } = await supabase
  .from('forge_projects')
  .select('*')
  .returns<Project[]>();
if (error) throw error;
```
**Wrong:**
```ts
const { data } = await supabase.from('forge_projects').select('*');
```

### API Route Patterns
- Validate with Zod.
- Response format `{ data, error }`.

**Correct:**
```ts
return NextResponse.json({ data, error: null }, { status: 200 });
```
**Wrong:**
```ts
return NextResponse.json(data);
```

---

## 7. Styling Conventions

### Tailwind Usage
- Utility-first; `@apply` only in `globals.css`.
- Class order: layout â†’ sizing â†’ spacing â†’ visual â†’ typography â†’ state.
- Use `cn()` for conditional classes.
- Use semantic tokens.

**Correct:**
```tsx
<div className={cn('flex w-full p-4 bg-surface text-sm hover:bg-surface/80')} />
```
**Wrong:**
```tsx
<div className="text-sm bg-surface p-4 flex w-full hover:bg-surface/80" />
```

### Forbidden Patterns
- No inline `style` except CSS vars.
- No CSS modules or styled-components.
- No `!important`.

**Correct:**
```tsx
<div style={{ '--progress': '42%' } as React.CSSProperties} />
```
**Wrong:**
```tsx
<div style={{ color: 'red' }} />
```

---

## 8. Performance Budgets & Rules

### Bundle Size
- Total JS gzipped < 200KB
- Largest route chunk < 50KB

### Lazy Loading
- Use `next/dynamic` for components >20KB or below-the-fold.
- Always use `next/image`.

**Correct:**
```tsx
const CostChart = dynamic(() => import('@/components/costs/CostChart'));
```
**Wrong:**
```tsx
import CostChart from '@/components/costs/CostChart';
```

### Rendering Strategy (Next.js)
- Default to Server Components.
- `'use client'` only when needed.

**Correct:**
```tsx
export default async function Page() {}
```
**Wrong:**
```tsx
'use client';
export default function Page() {}
```

### Prohibited Anti-patterns
- No `useEffect` for data fetching.
- No unkeyed `.map()`.
- No anonymous JSX handlers.
- No `moment.js`.

**Correct:**
```tsx
items.map((item) => <Row key={item.id} />);
```
**Wrong:**
```tsx
items.map((item) => <Row />);
```

---

## 9. Authentication Patterns

### Auth Context
Expose: `user`, `session`, `isLoading`, `signIn`, `signOut`.

**Correct:**
```ts
type AuthContextValue = { user: User | null; isLoading: boolean; signOut: () => Promise<void> };
```
**Wrong:**
```ts
type AuthContextValue = any;
```

### Route Protection
Middleware guards all routes except `/login` and `/api/auth/*`.

**Correct:**
```ts
return NextResponse.redirect(new URL(`/login?redirect=${path}`, req.url));
```
**Wrong:**
```ts
return NextResponse.next();
```

### RLS-Aware Patterns
Do not filter by user ID if RLS applies.

**Correct:**
```ts
supabase.from('forge_runs').select('*');
```
**Wrong:**
```ts
supabase.from('forge_runs').select('*').eq('user_id', userId);
```

### Session Management
On sign-out: clear React Query cache.

**Correct:**
```ts
queryClient.clear();
await supabase.auth.signOut();
```
**Wrong:**
```ts
await supabase.auth.signOut();
```

---

## 10. Testing Standards

### Test Framework
- Vitest + React Testing Library
- Playwright for e2e (if needed)

### Test File Location
Co-located with source.

**Correct:**
```
ProjectRow.tsx
ProjectRow.test.tsx
```
**Wrong:**
```
tests/ProjectRow.test.tsx
```

### Test Naming Convention
```tsx
describe('ProjectRow', () => {
  it('should render status when provided', () => {
    // Arrange - Act - Assert
  });
});
```

### What to Test
| Layer | What to test | What NOT to test |
|------|-------------|-----------------|
| UI components | Rendering, interactions, a11y | Implementation details |
| Hooks | Return values, transitions | useEffect internals |
| Utils | Pure inputs/outputs | 3rd-party behavior |
| API routes | Validation, response format | DB internals |

### Mocking Rules
- Mock Supabase client with typed factory.
- Mock `next/navigation`.
- Never mock React internals.

**Correct:**
```ts
vi.mock('next/navigation', () => ({ useRouter: () => ({ push: vi.fn() }) }));
```
**Wrong:**
```ts
vi.mock('react', () => ({ useState: vi.fn() }));
```

---

## 11. Git & PR Workflow

### Branch Naming
- `forge/{run_id}`

### Commit Messages
`type(scope): description`

**Correct:**
```
feat(runs): add status filter
```
**Wrong:**
```
update stuff
```

### PR Requirements
- `pnpm lint && pnpm typecheck && pnpm test` must pass.
- No `console.log`.
- No `TODO` without ticket.

**Correct:**
```ts
// TODO(CF-123): replace mock
```
**Wrong:**
```ts
// TODO
```

### Definition of Done
- [ ] AC met
- [ ] TS strict clean
- [ ] ESLint clean
- [ ] Tests >80% branch coverage
- [ ] Bundle budget met
- [ ] Lighthouse a11y >= 90
- [ ] Smoke test on preview

---

## 12. Dependency Policy

### Allowed Dependencies
Only those in `architecture.md`. New deps must be:
- <5KB gzipped
- >1M weekly downloads
- TS types
- actively maintained

### Forbidden Dependencies
| Package | Reason | Alternative |
|---------|--------|-------------|
| `lodash` (full) | Bundle bloat | `lodash-es` / native |
| `moment` | Deprecated, large | `date-fns` / `Intl` |
| `axios` | Unnecessary | native `fetch` |
| `styled-components` | Conflicts with Tailwind | Tailwind |
| `material-ui` | Design mismatch | UI primitives |

**Correct:**
```ts
const dt = new Intl.DateTimeFormat('fr-FR').format(new Date());
```
**Wrong:**
```ts
import moment from 'moment';
```

---
```